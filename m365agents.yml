# yaml-language-server: $schema=https://aka.ms/teams-toolkit-yaml-schema.json

# This is the main configuration file for Microsoft 365 Agents.
# Visit https://aka.ms/teamsfx-v5.0-guide for more information about this file.

version: 1.0.0

environmentFolderPath: ./env

# Defines what the `m365agents deploy` command does for different environments.
deploy:
  - uses: azureAppService/zipDeploy
    with:
      artifactFolder: .
      resourceId: /subscriptions/{{AZURE_SUBSCRIPTION_ID}}/resourceGroups/{{AZURE_RESOURCE_GROUP_NAME}}/providers/Microsoft.Web/sites/{{AZURE_FUNCTION_APP_NAME}}
      ignoreFile: .funcignore

# Defines what the `m365agents provision` command does for different environments.
provision:
  # Creates an Azure AD app registration for the bot.
  - uses: aadApp/create
    with:
      name: SOCBot-${{TEAMSFX_ENV}}
      generateClientSecret: true
      signInAudience: AzureADMyOrg
    writeToEnvironmentFile:
      clientId: M365_CLIENT_ID
      clientSecret: M365_CLIENT_SECRET
      objectId: M365_CLIENT_OBJECT_ID
      tenantId: M365_TENANT_ID
      authority: M365_AUTHORITY_HOST
      authorityHost: M365_AUTHORITY_HOST

  # Creates a Teams app
  - uses: teamsApp/create
    with:
      name: SOCBot-${{TEAMSFX_ENV}}
    writeToEnvironmentFile:
      teamsAppId: TEAMS_APP_ID

  # Configure Azure AD app for Teams SSO
  - uses: aadApp/update
    with:
      manifestPath: ./aad.manifest.json
      outputFilePath: ./build/aad.manifest.${{TEAMSFX_ENV}}.json

  # Build and upload the Teams app package
  - uses: teamsApp/validateManifest
    with:
      manifestPath: ./appPackage/manifest.json

  - uses: teamsApp/zipAppPackage
    with:
      manifestPath: ./appPackage/manifest.json
      outputZipPath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip
      outputJsonPath: ./appPackage/build/manifest.${{TEAMSFX_ENV}}.json

  - uses: teamsApp/update
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip
    writeToEnvironmentFile:
      teamsAppId: TEAMS_APP_ID

  # Deploy Azure infrastructure
  - uses: arm/deploy
    with:
      subscriptionId: ${{AZURE_SUBSCRIPTION_ID}}
      resourceGroupName: ${{AZURE_RESOURCE_GROUP_NAME}}
      templates:
        - path: ./infra/azure.bicep
          parameters: ./infra/azure.parameters.${{TEAMSFX_ENV}}.json
          deploymentName: Create-resources-for-${{TEAMSFX_ENV}}
        - path: ./infra/botRegistration/azurebot.bicep
          parameters: ./infra/botRegistration/azurebot.parameters.${{TEAMSFX_ENV}}.json
          deploymentName: Create-bot-registration-for-${{TEAMSFX_ENV}}
      bicepCliVersion: v0.15.31

# Defines what the `m365agents publish` command does for different environments.
publish:
  - uses: teamsApp/publishAppPackage
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip

projectId: 12345678-1234-1234-1234-123456789012